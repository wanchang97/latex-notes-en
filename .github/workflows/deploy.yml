name: Build and Deploy English LaTeX Notes

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

env:
  BUILD_DIR: public

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # å®‰è£…æ‰€æœ‰å¿…è¦çš„ TeX Live åŒ…
      - name: Setup LaTeX environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-latex-recommended \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-science \
            texlive-pictures

      # ç¼–è¯‘æ‰€æœ‰ç¬”è®°å’Œæ¼”ç¤ºæ–‡ç¨¿
      - name: Compile all notes
        run: |
          mkdir -p $BUILD_DIR/notes
          export TEXINPUTS="./styles:"

          # æŸ¥æ‰¾ 'notes' ç›®å½•ä¸‹æ‰€æœ‰ä¸€çº§å­æ–‡ä»¶å¤¹
          find notes -type d -mindepth 1 -maxdepth 1 | while read notedir; do
            foldername=$(basename "$notedir")
            
            # åœ¨æ¯ä¸ªç¬”è®°æ–‡ä»¶å¤¹å†…ï¼ŒæŸ¥æ‰¾æ‰€æœ‰é¡¶çº§ .tex æ–‡ä»¶è¿›è¡Œç¼–è¯‘
            find "$notedir" -maxdepth 1 -name "*.tex" -type f | while read texfile; do
              filename=$(basename "$texfile" .tex) # æå–æ–‡ä»¶åï¼ˆå¦‚ main æˆ– colloquioumPresentationï¼‰
              
              # è·³è¿‡ preamble.tex ç­‰è¾…åŠ©æ–‡ä»¶
              if [[ "$filename" == "preamble" ]]; then
                continue
              fi

              echo "ğŸ“˜ Compiling: $foldername/$filename"

              cd "$notedir"
              pdflatex -interaction=nonstopmode "$filename.tex" || true
              
              if [ -f "$filename.pdf" ]; then
                # å°† PDF å¤åˆ¶åˆ° BUILD_DIR/notes/ï¼Œå‘½åæ ¼å¼ä¸º FolderName_FileName.pdf
                target_name="${foldername}_${filename}.pdf"
                cp "$filename.pdf" "../../$BUILD_DIR/notes/${target_name}"
                echo "âœ… Success: Saved as $target_name"
              else
                echo "âŒ Failed: $foldername/$filename"
                grep -A 5 -B 5 "Error:" "$filename.log" || tail -20 "$filename.log"
              fi
              cd - > /dev/null
            done
          done

      # è¿è¡Œ Bash è„šæœ¬æ¥åˆ›å»ºç´¢å¼•é¡µé¢
      - name: Generate index page
        run: bash scripts/generate_index.sh

      # å°†ç”Ÿæˆçš„ public/ ç›®å½•å†…å®¹éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          force_orphan: true
