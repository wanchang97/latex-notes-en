#!/bin/bash
set -e

BUILD_DIR="public"
NOTES_DIR="$BUILD_DIR/notes"

echo "ğŸ§© Generating Markdown-style index page..."
mkdir -p "$BUILD_DIR"

INDEX_MD="$BUILD_DIR/index.md"
INDEX_HTML="$BUILD_DIR/index.html"

# ç”Ÿæˆ Markdown æ–‡ä»¶å¤´
{
  echo "# ğŸ“š My LaTeX Notes"
  echo ""
  echo "_Auto-generated on $(date)_"
  echo ""
  echo "## ğŸ—‚ï¸ Notes List (Newest First)"
  echo ""
} > "$INDEX_MD"

# æŸ¥æ‰¾æ‰€æœ‰ PDF å¹¶æŒ‰ä¿®æ”¹æ—¶é—´æ’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰
find "$NOTES_DIR" -type f -name "*.pdf" -printf "%T@ %p\n" \
  | sort -nr \
  | cut -d' ' -f2- \
  | while read -r pdf; do
      base=$(basename "$pdf" .pdf) # base æ˜¯æ–‡ä»¶åï¼Œä¾‹å¦‚ DecisionMakingModelling_main
      relpath="notes/${base}.pdf"

      # --- å…³é”®ä¿®æ”¹éƒ¨åˆ†ï¼šåˆ›å»ºå‹å¥½æ˜¾ç¤ºåç§° ---
      display_name="${base}"

      # 1. å°†æ–‡ä»¶åä¸­çš„ä¸‹åˆ’çº¿æ›¿æ¢ä¸ºç©ºæ ¼
      display_name="${display_name//_/ }"
      
      # 2. ä¸ºç‰¹å®šæ–‡ä»¶æ·»åŠ æè¿°æ€§åç¼€ï¼Œä»¥åŒºåˆ†æŠ¥å‘Šå’Œæ¼”ç¤ºæ–‡ç¨¿
      if [[ "$base" == *"_main"* ]]; then
        # åŒ¹é… DecisionMakingModelling_mainï¼Œå¹¶æ·»åŠ  (Report)
        display_name=$(echo "$display_name" | sed 's/ main$/ (Report)/')
      elif [[ "$base" == *"_colloquioumPresentation"* ]]; then
        # åŒ¹é… DecisionMakingModelling_colloquioumPresentationï¼Œå¹¶æ·»åŠ  (Colloquium Presentation)
        display_name=$(echo "$display_name" | sed 's/ colloquioumPresentation$/ (Colloquium Presentation)/')
      fi

      # 3. ç”Ÿæˆ Markdown åˆ—è¡¨é¡¹
      echo "- [${display_name}](${relpath})" >> "$INDEX_MD"
    done
# ----------------------------------------------

# æ·»åŠ é¡µè„š
{
  echo ""
  echo "---"
  echo "_Last updated: $(date)_"
} >> "$INDEX_MD"

# è½¬æ¢ Markdown -> HTML (è¿™éƒ¨åˆ†ä¿æŒåŸæ ·ï¼Œå› ä¸ºå®ƒè´Ÿè´£æ ¼å¼åŒ–)
{
cat <<EOF
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>My LaTeX Notes</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 40px; line-height: 1.6; color: #333; }
    h1, h2 { color: #2c3e50; }
    a { color: #007acc; text-decoration: none; }
    a:hover { text-decoration: underline; }
    code { background-color: #f4f4f4; padding: 2px 4px; border-radius: 3px; }
    hr { border: 0; border-top: 1px solid #ddd; margin: 30px 0; }
  </style>
</head>
<body>
<article>
EOF

# ç®€å• Markdown è½¬ HTMLï¼ˆä¿ç•™åŸºæœ¬æ ¼å¼ï¼‰
sed -E '
  s/^# (.*)$/<h1>\1<\/h1>/;
  s/^## (.*)$/<h2>\1<\/h2>/;
  s/^---$/<hr>/;
  s/^_([^_]+)_$/<em>\1<\/em>/;
  s/^- \[(.*)\]\((.*)\)$/<li><a href="\2" target="_blank">\1<\/a><\/li>/;
' "$INDEX_MD"

cat <<EOF
</article>
</body>
</html>
EOF
} > "$INDEX_HTML"

echo "âœ… Generated:"
echo " - $INDEX_MD"
echo " - $INDEX_HTML"
