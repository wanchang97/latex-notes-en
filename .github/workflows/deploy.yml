name: Build and Deploy English LaTeX Notes

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

env:
  BUILD_DIR: public

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup LaTeX environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-latex-recommended \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-science \
            texlive-pictures

      - name: Compile all notes
        run: |
          mkdir -p $BUILD_DIR/notes
          export TEXINPUTS="./styles:"

          find notes -name "main.tex" -type f | while read texfile; do
            dir=$(dirname "$texfile")
            name=$(basename "$dir")
            echo "ðŸ“˜ Compiling: $name"

            cd "$dir"
            pdflatex -interaction=nonstopmode main.tex || true

            if [ -f "main.pdf" ]; then
              cp main.pdf "../../$BUILD_DIR/notes/${name}.pdf"
              echo "âœ… Success: $name"
            else
              echo "âŒ Failed: $name"
              grep -A 5 -B 5 "Error:" main.log || tail -20 main.log
            fi
            cd - > /dev/null
          done

      - name: Generate index page
        run: bash scripts/generate_index.sh

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          force_orphan: true
