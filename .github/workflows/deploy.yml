name: Build and Deploy English LaTeX Notes

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

env:
  BUILD_DIR: public

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup LaTeX environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-latex-recommended \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-science \
            texlive-pictures

      - name: Compile all notes
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  mkdir -p $BUILD_DIR/notes
Â  Â  Â  Â  Â  export TEXINPUTS="./styles:"

Â  Â  Â  Â  Â  # --- ç¼–è¯‘é€»è¾‘å¼€å§‹ ---
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  # 1. æŸ¥æ‰¾æ‰€æœ‰ç¬”è®°æ–‡ä»¶å¤¹ (å¦‚ DecisionMakingModelling)
Â  Â  Â  Â  Â  find notes -type d -mindepth 1 -maxdepth 1 | while read notedir; do
Â  Â  Â  Â  Â  Â  foldername=$(basename "$notedir")
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  # 2. åœ¨æ¯ä¸ªç¬”è®°æ–‡ä»¶å¤¹å†…æŸ¥æ‰¾æ‰€æœ‰é¡¶çº§ .tex æ–‡ä»¶
Â  Â  Â  Â  Â  Â  find "$notedir" -maxdepth 1 -name "*.tex" -type f | while read texfile; do
Â  Â  Â  Â  Â  Â  Â  filename=$(basename "$texfile" .tex) # å¦‚ main æˆ– colloquioumPresentation
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  # è·³è¿‡ preamble.tex ç­‰è¾…åŠ©æ–‡ä»¶ (æ ¹æ®æ‚¨çš„ç›®å½•ç»“æ„ï¼Œå®ƒä»¬å¯èƒ½æ˜¯è¾…åŠ©æ–‡ä»¶)
Â  Â  Â  Â  Â  Â  Â  if [[ "$filename" == "preamble" ]]; then
Â  Â  Â  Â  Â  Â  Â  Â  continue
Â  Â  Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  Â  Â  echo "ğŸ“˜ Compiling: $foldername/$filename"

Â  Â  Â  Â  Â  Â  Â  cd "$notedir"
Â  Â  Â  Â  Â  Â  Â  pdflatex -interaction=nonstopmode "$filename.tex" || true
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  if [ -f "$filename.pdf" ]; then
Â  Â  Â  Â  Â  Â  Â  Â  # å…³é”®ä¿®æ”¹ï¼šå°† PDF å¤åˆ¶åˆ° BUILD_DIR/notes/ï¼Œå‘½åæ ¼å¼ä¸º FolderName_FileName.pdf
Â  Â  Â  Â  Â  Â  Â  Â  target_name="${foldername}_${filename}.pdf"
Â  Â  Â  Â  Â  Â  Â  Â  cp "$filename.pdf" "../../$BUILD_DIR/notes/${target_name}"
Â  Â  Â  Â  Â  Â  Â  Â  echo "âœ… Success: Saved as $target_name"
Â  Â  Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  Â  Â  echo "âŒ Failed: $foldername/$filename"
Â  Â  Â  Â  Â  Â  Â  Â  grep -A 5 -B 5 "Error:" "$filename.log" || tail -20 "$filename.log"
Â  Â  Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  Â  Â  cd - > /dev/null
Â  Â  Â  Â  Â  Â  done
Â  Â  Â  Â  Â  done
Â  Â  Â  Â  Â  # --- ç¼–è¯‘é€»è¾‘ç»“æŸ ---
    
          


      - name: Generate index page
        run: bash scripts/generate_index.sh

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          force_orphan: true
